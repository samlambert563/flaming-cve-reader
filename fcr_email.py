import feedparser
import re
import requests
from datetime import datetime
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from bs4 import BeautifulSoup

# List of RSS URLs to fetch
urls = [
    'https://www.bleepingcomputer.com/feed',
    'https://feeds.feedburner.com/TheHackersNews',
    'https://www.cisa.gov/cybersecurity-advisories/cybersecurity-advisories.xml',
    'https://www.theregister.com/security/patches/headlines.atom',
]

cve_numbers = []  # A list to store all the unique CVE numbers found in the feeds

for url in urls:
    feed = feedparser.parse(url)
    for entry in feed.entries:
        # Extract CVE numbers from the description using regular expressions
        # replace with = r'CVE-2023-\d{5}' if you are just interested in CVEs beginning with 2023
        cve_regex = r'CVE-\d{4}-\d{5}'
        cve_numbers += re.findall(cve_regex, entry.description)

        # Get the HTML content of the entry
        html_content = requests.get(entry.link).content

        # Parse the HTML content using BeautifulSoup
        soup = BeautifulSoup(html_content, 'html.parser')

        # Extract CVE numbers from the HTML content using regular expressions
        cve_numbers += re.findall(cve_regex, str(soup))

# Remove duplicates from the list
cve_numbers = list(set(cve_numbers))

# Get the current date and time
now = datetime.now()
dt_string = now.strftime("%Y-%m-%d %H:%M:%S")

# Check if new CVEs were found since the last run
with open('output.txt', 'r') as f:
    previous_cves = f.read().splitlines()
    if set(cve_numbers) == set(previous_cves):
        print("No new CVEs found. Email not sent.")
    else:
        new_cves = list(set(cve_numbers) - set(previous_cves))
        if new_cves:
            # Add quotes around each CVE number
            new_cves = [f'"{cve}"' for cve in new_cves]
            output = "CVEs to Threat Hunt: " + ", ".join(new_cves) + "\n\n"
        else:
            print("No new CVEs found. Email not sent.")
            exit()

        # Add the total number of unique CVEs to the output
        output += f"Total number of unique CVEs found: {len(cve_numbers)}"

        # Add the date and time to the output
        output += f"\n\nDate and Time: {dt_string}"

        # Write the output to the file
        with open('output.txt', 'w') as f:
            f.write('\n'.join(cve_numbers))

        # Step 1: Add your SMTP settings
        smtp_server = 'smtp.gmail.com'
        smtp_port = 587
        smtp_username = 'YourSMTP@gmail.com'
        smtp_password = 'AppPasswordHere'

        # Step 2: Add Recipient
        message = MIMEMultipart()
        message['From'] = 'Flaming CVE Reader'
        message['To'] = 'YourEmailHere@example.com'
        message['Subject'] = 'New CVE Numbers Found in Security Blogs'

        # Attach the output to the email body
        message.attach(MIMEText(output, 'plain'))
        
        # Connect to SMTP server and send email
        with smtplib.SMTP(smtp_server, smtp_port) as smtp:
            smtp.starttls()
            smtp.login(smtp_username, smtp_password)
            smtp.sendmail(message['From'], message['To'], message.as_string())
            print('Email sent successfully')
