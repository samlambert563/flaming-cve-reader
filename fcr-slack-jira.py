import feedparser
import re
import requests
from datetime import datetime
from bs4 import BeautifulSoup
import json

# Step 1 Add your  bot token and channel ID
bot_token = "xxxxtokenherexxxx"
channel_id = "xxxxchannelidherexxxx"

# Step 2 Add your Slack webhook URL
slack_webhook_url = 'https://hooks.slack.com/services/YOURWEBHOOKHERE'
# Step 3 Add your Jira automation URL
jira_automation_url = 'https://automation.atlassian.com/pro/hooks/YOURJIRAWBEHOOKHERE'

# List of RSS URLs to fetch
urls = [
    'https://www.bleepingcomputer.com/feed',
    'https://feeds.feedburner.com/TheHackersNews',
    'https://www.cisa.gov/cybersecurity-advisories/cybersecurity-advisories.xml',
    'https://www.theregister.com/security/patches/headlines.atom',
]

cve_numbers = []  # A list to store all the unique CVE numbers found in the feeds

for url in urls:
    feed = feedparser.parse(url)
    for entry in feed.entries:
        # Extract CVE numbers from the description using regular expressions
        cve_regex = r'CVE-\d{4}-\d{5}'
        cve_numbers += re.findall(cve_regex, entry.description)

        # Get the HTML content of the entry
        html_content = requests.get(entry.link).content

        # Parse the HTML content using BeautifulSoup
        soup = BeautifulSoup(html_content, 'html.parser')

        # Extract CVE numbers from the HTML content using regular expressions
        cve_numbers += re.findall(cve_regex, str(soup))

# Remove duplicates from the list
cve_numbers = list(set(cve_numbers))

# Get the current date and time
now = datetime.now()
dt_string = now.strftime("%Y-%m-%d %H:%M:%S")

def send_slack_webhook(message):
    headers = {
        "Content-Type": "application/json"
    }
    payload = {
        "blocks": [
            {
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": message
                }
            },
            {
                "type": "actions",
                "elements": [
                    {
                        "type": "button",
                        "text": {
                            "type": "plain_text",
                            "text": "Threat Hunt in EDR"
                        },
                        "style": "primary",
                        "url": "https://www.example.com/your_hyperlink1"
                    },
                    {
                        "type": "button",
                        "text": {
                            "type": "plain_text",
                            "text": "Threat Hunt in SIEM"
                        },
                        "style": "primary",
                        "url": "https://www.example.com/your_hyperlink2"
                    }
                ]
            }
        ]
    }

    response = requests.post(slack_webhook_url, headers=headers, data=json.dumps(payload))

    if response.status_code == 200:
        print("Message sent successfully!")
    else:
        print(f"Error sending message: {response.status_code}, {response.text}")

        # Function to create Jira ticket
def send_jira_webhook(summary, description):
    headers = {
        "Content-Type": "application/json"
    }
    payload = {
        "issues": [],
        "data": {
            "summary": summary,
            "description": description
        }
    }
    response = requests.post(jira_automation_url, headers=headers, json=payload)

    if response.status_code == 200 or response.status_code == 201:
        print("Jira ticket created successfully!")
    else:
        print(f"Error creating Jira ticket: {response.status_code}, {response.text}")


    # Check if new CVEs were found since the last run
with open('output.txt', 'r') as f:
    previous_cves = f.read().splitlines()
    if set(cve_numbers) == set(previous_cves):
        print("No new CVEs found. Message not sent.")
    else:
        new_cves = list(set(cve_numbers) - set(previous_cves))
        if new_cves:
            # Add quotes around each CVE number
            new_cves = [f'"{cve}"' for cve in new_cves]
            output = "CVEs to Threat Hunt: " + ", ".join(new_cves) + "\n\n"
        else:
            print("No new CVEs found. Message not sent.")
            exit()

        # Add the total number of unique CVEs to the output
        output += f"Total number of unique CVEs found: {len(cve_numbers)}"

        # Add the date and time to the output
        output += f"\n\nDate and Time: {dt_string}"

        # Prepare the summary and description for the Jira ticket
        summary = "New CVEs found"
        description = output

        # Send the message to Slack
        send_slack_webhook(output)

        
       # Call the send_jira_webhook function
        send_jira_webhook(summary, description)



        # Write the output to the file
        with open('output.txt', 'w') as f:
            f.write('\n'.join(cve_numbers))
